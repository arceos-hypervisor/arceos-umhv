# 远程 CI 运行

## 0. 为什么需要远程 CI

> 和直觉不同，此处“本地”指 GitHub 服务器，而“远程”指我们所控制并使用的，相对于 GitHub 服务器而言是“远程”的服务器。

需要远程 CI 的原因有很多，最主要的，也是本次工作最直接的原因是：GitHub Actions 所使用的硬件是我们完全无法控制的。在大部分情况下，这并不是一个问题；然而在 Hypervisor 开发过程中，Intel 和 AMD 的 CPU 采用了不同的虚拟化技术；由于目前我们只实现了 Intel 的虚拟化技术，因此在 GitHub Actions 所运行的 AMD CPU 上无法运行 Hypervisor；即使未来我们实现了 AMD 的虚拟化技术，也无法在 GitHub Actions 的硬件同时测试两种虚拟化技术。因此，使用远程 CI 进行测试成为了一种必需。

除此之外，远程 CI 还有很多其他的优点。虽然当下我们并未完全利用这些优点，但是在未来，这些优点将会成为我们的优势：

- 更充足的硬件资源；
- 更详细的日志信息；
- 当遇到硬件和操作系统环境相关的问题时，可以更方便地调试；
- 更加丰富的操作，例如自动测试有依赖关系的crate；
- 避免 QEMU 和 musl 环境反复构建；
- ……

这里我们在 `axvisor` 仓库中实现了远程 CI 测试。实现细节可以参考[这个文件](./test.yml)以及下文的描述。有需要的话，可以参考这个文件来实现其他仓库的远程 CI 测试。

## 1. 如何运行远程 CI

要在远程服务器上运行 CI，本质上是需要在远程服务器上完成两件事情：

1. 获得仓库的内容，包括代码和 CI 配置；
2. 根据配置，运行 CI 命令。

一个最容易想到的方式是：

1. 通过 SSH 连接到远程服务器；
2. 在远程服务器上使用 `git clone` 命令拉取仓库；
3. 在远程服务器上设法执行 `.github/workflows` 目录下的 CI 配置文件。

这种方式最大限度地复用了现存的工具和配置文件，如果可行的话，几乎就是最好的选择。然而，目前存在以下几个问题，使得这种方式不太可行：

1. `git clone` 需要良好且科学的网络连接，这一点有的时候会成为问题；如果使用自有设备，如何配置上网环境，如何确保它可靠都是问题；如果使用境外服务器，CI 所需的配置并不算很低，但利用率其实不会特别高，因此机器费用很可能成为一个问题；
2. 要执行 GitHub Actions 的配置文件，实际上是有现成的工具的，例如 `act`，但实际上受限于 docker 环境的配置和科学网络（同上一点）的问题，我并没有成功使用过这个工具。

因此，目前我们采用了最简单的方式来运行远程 CI：通过 GitHub Actions 启动一个 SSH 连接，然后在远程服务器上直接运行 CI 测试的命令。具体来说，在远程服务器上运行测试所需的所有环境都已经配置好，所有文件（包括代码和测试所需的镜像）则都由 GitHub Actions 打包并上传到远程服务器，远程服务器只用执行最后实际运行 Hypervisor 并测试的命令即可。

## 2. 未来的一些可能的改进

虽然目前的远程 CI 已经能够基本满足我们的需求，但是仍然有一些改进的空间：

1. 使用 `act` 工具来运行 CI 测试。这样可以避免运行命令重复书写的问题。
2. 更好的 SSH 工具。目前我们使用的是 `appleboy/ssh-action` 和 `appleboy/scp-action`，这两个工具都是由同一个作者编写的，功能足够使用，但是在实际运行中，配置有一些反直觉，也有一些无法配置的项目。如果有更好的工具，可以考虑替换。
3. 更好的 cache 策略。正确且高效地 cache qemu 等运行环境是一项非常大的改进。因为目前 setup-qemu 耗费了非常多的时间。
4. 自动环境配置：目前，远程测试机上的环境是手动配置的。如果能够自动配置，那么更换测试机器的时候就会更加方便。

最后还有一点：**目前测试都是在我的私人服务器上跑的。资源有限，SLI 也不太好。急需更好更稳定的服务器😂。**
